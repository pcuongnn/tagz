(function(){var e,t,r,n,a,i,o,s,l,u,c,d,p,h,f,m,v,g,y,C=[].slice,S=[].indexOf||function(e){for(var t=0,r=this.length;r>t;t++)if(t in this&&this[t]===e)return t;return-1};e=jQuery,e.payment={},e.payment.fn={},e.fn.payment=function(){var t,r;return r=arguments[0],t=2<=arguments.length?C.call(arguments,1):[],e.payment.fn[r].apply(this,t)},a=/(\d{1,4})/g,n=[{type:"maestro",pattern:/^(5018|5020|5038|6304|6759|676[1-3])/,format:a,length:[12,13,14,15,16,17,18,19],cvcLength:[3],luhn:!0},{type:"dinersclub",pattern:/^(36|38|30[0-5])/,format:a,length:[14],cvcLength:[3],luhn:!0},{type:"laser",pattern:/^(6706|6771|6709)/,format:a,length:[16,17,18,19],cvcLength:[3],luhn:!0},{type:"jcb",pattern:/^35/,format:a,length:[16],cvcLength:[3],luhn:!0},{type:"unionpay",pattern:/^62/,format:a,length:[16,17,18,19],cvcLength:[3],luhn:!1},{type:"discover",pattern:/^(6011|65|64[4-9]|622)/,format:a,length:[16],cvcLength:[3],luhn:!0},{type:"mastercard",pattern:/^5[1-5]/,format:a,length:[16],cvcLength:[3],luhn:!0},{type:"amex",pattern:/^3[47]/,format:/(\d{1,4})(\d{1,6})?(\d{1,5})?/,length:[15],cvcLength:[3,4],luhn:!0},{type:"visa",pattern:/^4/,format:a,length:[13,14,15,16],cvcLength:[3],luhn:!0}],t=function(e){var t,r,a;for(e=(e+"").replace(/\D/g,""),r=0,a=n.length;a>r;r++)if(t=n[r],t.pattern.test(e))return t},r=function(e){var t,r,a;for(r=0,a=n.length;a>r;r++)if(t=n[r],t.type===e)return t},p=function(e){var t,r,n,a,i,o;for(n=!0,a=0,r=(e+"").split("").reverse(),i=0,o=r.length;o>i;i++)t=r[i],t=parseInt(t,10),(n=!n)&&(t*=2),t>9&&(t-=9),a+=t;return a%10===0},d=function(e){var t;return null!=e.prop("selectionStart")&&e.prop("selectionStart")!==e.prop("selectionEnd")?!0:("undefined"!=typeof document&&null!==document&&null!=(t=document.selection)&&"function"==typeof t.createRange?t.createRange().text:void 0)?!0:!1},h=function(t){return setTimeout(function(){var r,n;return r=e(t.currentTarget),n=r.val(),n=e.payment.formatCardNumber(n),r.val(n)})},s=function(r){var n,a,i,o,s,l,u;return i=String.fromCharCode(r.which),!/^\d+$/.test(i)||(n=e(r.currentTarget),u=n.val(),a=t(u+i),o=(u.replace(/\D/g,"")+i).length,l=16,a&&(l=a.length[a.length.length-1]),o>=l||null!=n.prop("selectionStart")&&n.prop("selectionStart")!==u.length)?void 0:(s=a&&"amex"===a.type?/^(\d{4}|\d{4}\s\d{6})$/:/(?:^|\s)(\d{4})$/,s.test(u)?(r.preventDefault(),n.val(u+" "+i)):s.test(u+i)?(r.preventDefault(),n.val(u+i+" ")):void 0)},i=function(t){var r,n;return r=e(t.currentTarget),n=r.val(),t.meta||8!==t.which||null!=r.prop("selectionStart")&&r.prop("selectionStart")!==n.length?void 0:/\d\s$/.test(n)?(t.preventDefault(),r.val(n.replace(/\d\s$/,""))):/\s\d?$/.test(n)?(t.preventDefault(),r.val(n.replace(/\s\d?$/,""))):void 0},l=function(t){var r,n,a;return n=String.fromCharCode(t.which),/^\d+$/.test(n)?(r=e(t.currentTarget),a=r.val()+n,/^\d$/.test(a)&&"0"!==a&&"1"!==a?(t.preventDefault(),r.val("0"+a+" / ")):/^\d\d$/.test(a)?(t.preventDefault(),r.val(""+a+" / ")):void 0):void 0},u=function(t){var r,n,a;return n=String.fromCharCode(t.which),/^\d+$/.test(n)?(r=e(t.currentTarget),a=r.val(),/^\d\d$/.test(a)?r.val(""+a+" / "):void 0):void 0},c=function(t){var r,n,a;return n=String.fromCharCode(t.which),"/"===n?(r=e(t.currentTarget),a=r.val(),/^\d$/.test(a)&&"0"!==a?r.val("0"+a+" / "):void 0):void 0},o=function(t){var r,n;if(!t.meta&&(r=e(t.currentTarget),n=r.val(),8===t.which&&(null==r.prop("selectionStart")||r.prop("selectionStart")===n.length)))return/\d(\s|\/)+$/.test(n)?(t.preventDefault(),r.val(n.replace(/\d(\s|\/)*$/,""))):/\s\/\s?\d?$/.test(n)?(t.preventDefault(),r.val(n.replace(/\s\/\s?\d?$/,""))):void 0},g=function(e){var t;return e.metaKey||e.ctrlKey?!0:32===e.which?!1:0===e.which?!0:e.which<33?!0:(t=String.fromCharCode(e.which),!!/[\d\s]/.test(t))},m=function(r){var n,a,i,o;return n=e(r.currentTarget),i=String.fromCharCode(r.which),/^\d+$/.test(i)&&!d(n)?(o=(n.val()+i).replace(/\D/g,""),a=t(o),a?o.length<=a.length[a.length.length-1]:o.length<=16):void 0},v=function(t){var r,n,a;return r=e(t.currentTarget),n=String.fromCharCode(t.which),/^\d+$/.test(n)&&!d(r)?(a=r.val()+n,a=a.replace(/\D/g,""),a.length>6?!1:void 0):void 0},f=function(t){var r,n,a;return r=e(t.currentTarget),n=String.fromCharCode(t.which),/^\d+$/.test(n)?(a=r.val()+n,a.length<=4):void 0},y=function(t){var r,a,i,o,s;return r=e(t.currentTarget),s=r.val(),o=e.payment.cardType(s)||"unknown",r.hasClass(o)?void 0:(a=function(){var e,t,r;for(r=[],e=0,t=n.length;t>e;e++)i=n[e],r.push(i.type);return r}(),r.removeClass("unknown"),r.removeClass(a.join(" ")),r.addClass(o),r.toggleClass("identified","unknown"!==o),r.trigger("payment.cardType",o))},e.payment.fn.formatCardCVC=function(){return this.payment("restrictNumeric"),this.on("keypress",f),this},e.payment.fn.formatCardExpiry=function(){return this.payment("restrictNumeric"),this.on("keypress",v),this.on("keypress",l),this.on("keypress",c),this.on("keypress",u),this.on("keydown",o),this},e.payment.fn.formatCardNumber=function(){return this.payment("restrictNumeric"),this.on("keypress",m),this.on("keypress",s),this.on("keydown",i),this.on("keyup",y),this.on("paste",h),this},e.payment.fn.restrictNumeric=function(){return this.on("keypress",g),this},e.payment.fn.cardExpiryVal=function(){return e.payment.cardExpiryVal(e(this).val())},e.payment.cardExpiryVal=function(e){var t,r,n,a;return e=e.replace(/\s/g,""),a=e.split("/",2),t=a[0],n=a[1],2===(null!=n?n.length:void 0)&&/^\d+$/.test(n)&&(r=(new Date).getFullYear(),r=r.toString().slice(0,2),n=r+n),t=parseInt(t,10),n=parseInt(n,10),{month:t,year:n}},e.payment.validateCardNumber=function(e){var r,n;return e=(e+"").replace(/\s+|-/g,""),/^\d+$/.test(e)?(r=t(e),r?(n=e.length,S.call(r.length,n)>=0&&(r.luhn===!1||p(e))):!1):!1},e.payment.validateCardExpiry=function(t,r){var n,a,i,o;return"object"==typeof t&&"month"in t&&(o=t,t=o.month,r=o.year),t&&r?(t=e.trim(t),r=e.trim(r),/^\d+$/.test(t)&&/^\d+$/.test(r)&&parseInt(t,10)<=12?(2===r.length&&(i=(new Date).getFullYear(),i=i.toString().slice(0,2),r=i+r),a=new Date(r,t),n=new Date,a.setMonth(a.getMonth()-1),a.setMonth(a.getMonth()+1,1),a>n):!1):!1},e.payment.validateCardCVC=function(t,n){var a,i;return t=e.trim(t),/^\d+$/.test(t)?n?(a=t.length,S.call(null!=(i=r(n))?i.cvcLength:void 0,a)>=0):t.length>=3&&t.length<=4:!1},e.payment.cardType=function(e){var r;return e?(null!=(r=t(e))?r.type:void 0)||null:null},e.payment.formatCardNumber=function(e){var r,n,a,i;return(r=t(e))?(a=r.length[r.length.length-1],e=e.replace(/\D/g,""),e=e.slice(0,+a+1||9e9),r.format.global?null!=(i=e.match(r.format))?i.join(" "):void 0:(n=r.format.exec(e),null!=n&&n.shift(),null!=n?n.join(" "):void 0)):e}}).call(this),function(){Spree.disableSaveOnClick=function(){return $("form.edit_order").submit(function(){return $(this).find(":submit, :image").attr("disabled",!0).removeClass("primary").addClass("disabled")})},Spree.ready(function(e){return Spree.Checkout={}})}.call(this),function(){Spree.ready(function(e){return Spree.onAddress=function(){var t,r,n;return e("#checkout_form_address").is("*")?(e("#checkout_form_address").validate(),t=function(t){return e("#"+t+"country select").val()},Spree.updateState=function(r){var n;return n=t(r),null!=n?null==Spree.Checkout[n]?e.get(Spree.routes.states_search,{country_id:n},function(e){return Spree.Checkout[n]={states:e.states,states_required:e.states_required},Spree.fillStates(Spree.Checkout[n],r)}):Spree.fillStates(Spree.Checkout[n],r):void 0},Spree.fillStates=function(t,r){var n,a,i,o,s,l,u,c;return u=t.states_required,l=t.states,i=e("#"+r+"state"),o=i.find("select"),a=i.find("input"),s=i.find('[id$="state-required"]'),l.length>0?(n=parseInt(o.val()),o.html(""),c=[{name:"",id:""}].concat(l),e.each(c,function(t,r){var a;return a=e(document.createElement("option")).attr("value",r.id).html(r.name),n===r.id&&a.prop("selected",!0),o.append(a)}),o.prop("disabled",!1).show(),a.hide().prop("disabled",!0),i.show(),s.show(),u&&o.addClass("required"),o.removeClass("hidden"),a.removeClass("required")):(o.hide().prop("disabled",!0),a.show(),u?(s.show(),a.addClass("required")):(a.val(""),s.hide(),a.removeClass("required")),i.toggle(!!u),a.prop("disabled",!u),a.removeClass("hidden"),o.removeClass("required"))},e("#bcountry select").change(function(){return Spree.updateState("b")}),e("#scountry select").change(function(){return Spree.updateState("s")}),Spree.updateState("b"),r=e("input#order_use_billing"),r.change(function(){return n(r)}),(n=function(t){return t.is(":checked")?(e("#shipping .inner").hide(),e("#shipping .inner input, #shipping .inner select").prop("disabled",!0)):(e("#shipping .inner").show(),e("#shipping .inner input, #shipping .inner select").prop("disabled",!1),Spree.updateState("s"))})(r)):void 0},Spree.onAddress()})}.call(this),function(){Spree.ready(function(e){return Spree.onPayment=function(){return e("#checkout_form_payment").is("*")?(e("#existing_cards").is("*")&&(e("#payment-method-fields").hide(),e("#payment-methods").hide(),e("#use_existing_card_yes").click(function(){return e("#payment-method-fields").hide(),e("#payment-methods").hide(),e(".existing-cc-radio").prop("disabled",!1)}),e("#use_existing_card_no").click(function(){return e("#payment-method-fields").show(),e("#payment-methods").show(),e(".existing-cc-radio").prop("disabled",!0)})),e(".cardNumber").payment("formatCardNumber"),e(".cardExpiry").payment("formatCardExpiry"),e(".cardCode").payment("formatCardCVC"),e(".cardNumber").change(function(){return e(this).parent().siblings(".ccType").val(e.payment.cardType(this.value))}),e('input[type="radio"][name="order[payments_attributes][][payment_method_id]"]').click(function(){return e("#payment-methods li").hide(),this.checked?e("#payment_method_"+this.value).show():void 0}),e(document).on("click","#cvv_link",function(t){var r,n;return r="cvv_info",n="left=20,top=20,width=500,height=500,toolbar=0,resizable=0,scrollbars=1",window.open(e(this).attr("href"),r,n),t.preventDefault()}),e('input[type="radio"]:checked').click(),e("#checkout_form_payment").submit(function(){var t,r,n,a;return r=e("#order_coupon_code"),t=e.trim(r.val()),""!==t?(0===e("#coupon_status").length?(n=e("<div id='coupon_status'></div>"),r.parent().append(n)):n=e("#coupon_status"),a=Spree.url(Spree.routes.apply_coupon_code(Spree.current_order_id),{order_token:Spree.current_order_token,coupon_code:t}),n.removeClass(),e.ajax({async:!1,method:"PUT",url:a,success:function(e){return r.val(""),n.addClass("alert-success").html("Coupon code applied successfully."),!0},error:function(t){var r;return r=JSON.parse(t.responseText),n.addClass("alert-error").html(r.error),e(".continue").attr("disabled",!1),!1}})):void 0})):void 0},Spree.onPayment()})}.call(this);